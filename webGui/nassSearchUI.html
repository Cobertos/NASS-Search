<!DOCTYPE html>
<html>
<head>
<title>NHTSA NASS Search Tool</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
"use strict";

function isDef(o)
{
	return !(typeof o === "undefined" || o === null);
}
function is(o, which)
{
	switch(which)
	{
		case "func":
			return typeof o === "function";
		case "obj":
			return Object.prototype.toString.call(o) === "[object Object]";
		case "array":
			return Object.prototype.toString.call(o) === "[object Array]";
		case "string":
			return typeof o === "string";
		default:
			throw "Invalid which \"" + which + "\" specified for comparison";
	}
}

(function(NASSSearch){
	function NASSSearchJoin(val)
	{
		var findName = null;
		$.each(NASSSearchJoin.values, function(name, v){
			if(val == v)
			{
				findName = name;
				return false;
			}
		});
		if(!isDef(findName))
			throw "NASSSearchJoin with value " + val + " does not exist";
		this.name = findName;
		this.val = val;
	}
	NASSSearchJoin.values = {
		"AND" : 0,
		"OR" : 1
	};
	$.each(NASSSearchJoin.values, function(name, val){
		NASSSearchJoin[name] = new NASSSearchJoin(val);
	});

	//Holds an entire search similar to the python version
	function NASSSearchTerm(terms)
	{
		this.inverse = false;
		this.terms = terms;
		this.errorCheck();
		
		this.flagDelete = false;
	};
	NASSSearch.NASSSearchTerm = NASSSearchTerm;
	NASSSearchTerm.prototype.errorCheck = function(){
		//Safety check for empty lists
		if(this.terms.length == 0)
			throw "No search terms were given"
		//Error check a dictionary (or in javascript, a plain object as an assoc array) (db Term)
		if(is(this.terms, "obj"))
		{
			var keys = Object.keys(this.terms);
			if(keys.length != 4 || !($.inArray("dbName", keys) > -1) || !($.inArray("colName", keys) > -1) || !($.inArray("searchValue", keys) > -1) || !($.inArray("compareFunc", keys) > -1))
				throw "Dictionary for search term did not contain the right terms";
		}
		//Error check an array (list term)
		else if(is(this.terms, "array"))
		{
			if(this.terms.length == 1)
				throw "Only one search term given. Do not create list terms containing one term.";
			if(this.terms.length % 2 != 1)
				throw "Search must contain an odd number of terms";
				
			$.each(this.terms, function(idx, term){
				//Even Term
				if(idx % 2 == 0 && !(term instanceof NASSSearchTerm))
					throw "Even term was not a search term";
				//Odd Term
				else if(idx % 2 == 1 && !(term instanceof NASSSearchJoin))
					throw "Odd term was not a join term";
				//Recursive check
				if(term instanceof NASSSearchTerm)
					term.errorCheck();
			});
		}
		else
		{
			throw "Terms was not a dict term or a list term";
		}
	};
	NASSSearchTerm.prototype.prune = function()
	{
		if(is(this.terms, "obj"))
			return; //Nothing we can do about ourselves
		else if(is(this.terms, "array"))
		{
			var self = this;
			$.each(this.terms, function(idx, term){
				if(term instanceof NASSSearchTerm && term.flagDelete)
				{
					if(idx == self.terms.length-1)
					{
						//Last term, must remove the join before, not after
						self.terms.splice(idx-1,2);
					}
					else
					{
						//Remove the term and following join
						self.terms.splice(idx, 2);
					}
					return false; //Should only delete once per prune of an item (for now)
				}
				else if(term instanceof NASSSearchTerm)
				{
					term.prune();
				}
			});
			//If there's only one element left, make this object a dict object
			if(this.terms.length == 1)
				this.terms = this.terms[0].terms;
		}
	};
	NASSSearchTerm.prototype.remove = function()
	{
		this.flagDelete = true;
	};
	NASSSearchTerm.prototype.add = function()
	{
		var blankTerm = new NASSSearchTerm(
		{"dbName":"Empty",
		"colName":"Empty",
		"searchValue":"Empty",
		"compareFunc":"Empty"});
		
		if(is(this.terms, "obj"))
			this.terms = [new NASSSearchTerm(this.terms), NASSSearchJoin.AND, blankTerm];
		else if(is(this.terms, "array"))
		{
			this.terms.push(NASSSearchJoin.AND);
			this.terms.push(blankTerm);
		}
	};
	NASSSearchTerm.prototype.toDOM = function()
	{
		var topTerm = "<div class=\"term" + (this.invert ? " not" : "") + (is(this.terms, "obj") ? " dbTerm" : " listTerm") + "\">";
		topTerm += (this.invert ? "<div class=\"uprLeft\">Not</div>" : "");
		topTerm += "</div>";
		topTerm = $.parseHTML(topTerm)[0];
		topTerm.NASSTerm = this; //Save ourselves on the DOM node for future reference
		
		var nodes;
		if(is(this.terms, "obj"))
		{
			nodes = $.parseHTML("<div class=\"uprLeft\">" + this.terms["dbName"] + "</div>" + this.terms["colName"] + " == " + this.terms["searchValue"]);
		}
		else if(is(this.terms, "array"))
		{
			nodes = []
			$.each(this.terms, function(idx, term){
				if(term instanceof NASSSearchTerm)
					nodes.push(term.toDOM());
				else if(term instanceof NASSSearchJoin)
					nodes.push($.parseHTML("<div class=\"term join\">" + term.name + "</div>")[0]);
			});
		}
		$.each(nodes, function(idx, node){
			topTerm.appendChild(node);
		});
		
		return topTerm;
	};
	
	
	function NASSSearchControl(jControlEl, jVisualEl)
	{
		//Set up the visual search portion
		this.search = new NASSSearch.NASSSearchTerm({
		"dbName" : "DB_A",
		"colName" : "Field_1",
		"searchValue" : "Value1",
		"compareFunc" : "stringEquals"});
		this.jVisualEl = jVisualEl;
		this.jVisualEl.html(this.search.toDOM());
		this.jSelectedEl = null;
		//Handlers
		var self = this;
		this.jVisualEl.on("mouseover", ".term", function(e){
			e.stopPropagation();
			$(e.target).addClass("hover");
		});
		this.jVisualEl.on("mouseout", ".term", function(e){
			$(e.target).removeClass("hover");
		});
		
		this.jVisualEl.on("click", ".term", function(e){
			var jEl = $(e.target);
			
			if(isDef(self.jSelectedEl))
			{
				self.jSelectedEl.removeClass("focus");
			}
			self.jSelectedEl = jEl;
			jEl.addClass("focus");
			
			if(jEl.is(".dbTerm"))
			{
				self.showPanel("dbTermPanel");
			}
			else if(jEl.is(".listTerm"))
			{
				self.showPanel("listTermPanel");
			}
			else if(jEl.is(".join"))
			{
				self.showPanel("joinPanel");
			}
			
			//Get all values from selectedEl and apply them to the panel
			
			
		});
	
		//Set up the control panels
		this.jControlPanelEls = jControlEl.children();
		this.jControlPanelEls.css("display", "none");
		this.jCurrPanelEl = null; //Start with no panel
		//Handlers
		jControlEl.on("click", "input[type='button'][name='addButton']", function(e){
			self.jSelectedEl[0].NASSTerm.add();
			self.jVisualEl.html(self.search.toDOM());
		});
		jControlEl.on("click", "input[type='button'][name='deleteButton']", function(e){
			self.jSelectedEl[0].NASSTerm.remove();
			self.search.prune();
			self.jVisualEl.html(self.search.toDOM());
		});

		/*jControlEl.on("click", "*", function(e){
			//Whenever anything changes, apply to selected term
			//toDOM the whole things
		});*/
	}
	NASSSearch.NASSSearchControl = NASSSearchControl;
	NASSSearchControl.prototype.showPanel = function(which)
	{
		if(isDef(which))
		{
			var foundPanel = this.jControlPanelEls.filter("." + which);
			if(foundPanel.length <= 0)
				throw "Control panel " + which + " not found";
			this.jCurrPanelEl = foundPanel;
			this.jControlPanelEls.css("display", "none");
			this.jCurrPanelEl.css("display", "block");
			
			//Should populate the panel with appropriate data
		}
		else
		{
			this.jControlPanelEls.css("display", "none");
			this.jCurrPanelEl = null;
		}
	};
	//Returns all the current panel fields as a dictionary
	NASSSearchControl.prototype.applyDataToTerm = function(term)
	{
		if(!isDef(this.jCurrPanelEl))
			throw "No current panel to get data from";
			
		$.each(this.jControlPanelEls.children("select, input").filter(":not(input[type='button']"), function(idx, jEl){
			term[jEl.attr("name")] = jEl.val();
		});
	};
	//USes a dictionary (data) to populate the panel
	NASSSearchControl.prototype.getDataFromTerm = function(term)
	{
		if(!isDef(this.jCurrPanelEl))
			throw "No current panel to apply data to";
			
		$.each(this.jControlPanelEls.children("select, input").filter(":not(input[type='button']"), function(idx, jEl){
			jEl.val(term[jEl.attr("name")]);
		});
	};
	
	
})(window.NASSSearch = window.NASSSearch || {});

window.addEventListener("load", function(){
var control = new NASSSearch.NASSSearchControl($("#searchControl"), $("#searchVisual"));
});

</script>
<style type="text/css">
body
{
	/*background-image:url("./bg.png"); My eyes!!! */
	background-repeat:repeat;
	padding:0;
	border:0;
	margin:0;
}


/*The visual search box*/
#searchContainer
{
	margin:0;
	margin-left:auto;
	margin-right:auto;
	max-width:1200px;
	min-width:600px;
}
#searchControl
{
	display:inline-block;
	width:500px;
	min-height:50px;
	background-color: #D0D0D0;
}
#searchVisual
{
	display:inline-block;
	float:right;
}

#searchVisual div.term
{
	position:relative;
	display:inline-block;
	
	margin:4px;
	padding:4px;
	border:solid #000000 1px;
	background-color: #D0D0D0;
	cursor: pointer;
}
#searchVisual div.term.hover
{
	background-color: #F5F5F5;
}
#searchVisual div.term.dbTerm
{
	padding-top:12px;
}
#searchVisual div.term.listTerm
{
	padding-top:8px;
}
#searchVisual div.term.join
{
	border: 0;
}
#searchVisual div.term.not
{
	background-color:#F2CCCC;
}
#searchVisual div.term.not:hover
{
	background-color:#F6D0D0;
}
#searchVisual div.term > div.uprLeft
{
	position:absolute;
	left:0;
	top:0;
	font-size:10px;
	font-weight:bold;
	font-family:Arial, Sans-Serif;
}
#searchVisual div.term.focus
{
	background-color:#EEEED0;
}

div.searchParams
{
	
}
table td
{
	padding-left:10px;
	padding-right:10px;
}
table tr:first-child
{
	background-color:#FFFFFF;
}
</style>
</head>
<body>
<span style="font-size:30px; font-family:Arial, sans-serif;">NHTSA NASS Search Tool</span><br>

<div id="searchContainer">
	<div id="searchControl">
		<div class="dbTermPanel">
			Not: <input type="checkbox" name="inverse">
			Database: <select name="dbName">
			<option></option>
			<option></option>
			</select>
			Column: <select name="colName">
			<option></option>
			<option></option>
			</select>
			Search Value: <input name="searchValue" type="text">
			Search Type: <select name="compareFunc">
			<option></option>
			<option></option>
			</select>
			<input type="button" name="addButton" value="New Parenthesis Term">
			<input type="button" name="deleteButton" value="Delete Term">
		</div>
		<div class="joinPanel">
			Join: <select name="joinSelect">
			<option>And</option>
			<option>Or</option>
			</select>
		</div>
		<div class="listTermPanel">
			<input type="button" name="addButton" value="Add Term">
		</div>
	</div>
	<div id="searchVisual">
		<!--User builds search with javascript/jQuery here-->
	</div>
</div>

<div>
	<table border="0">
	<tr>
		<td>Case #</td>
		<td>Link to Case</td>
		<td>Matched filter</td>
		<td>Excerpt</td>
	</tr>
	<tr>
		<td>Case # 1</td>
		<td><a href="#">Link to Case</a></td>
		<td>DB_C| A_Field == aaa</td>
		<td>&quote; some sentence where <span style="font-weight:bold">aaa</span> appears in the report &quote;</td>
	</tr>
	<tr>
		<td>Case # 2</td>
		<td><a href="#">Link to Case</a></td>
		<td>DB_C| C_Field == ccc</td>
		<td>&quote; in conclusion it was determined that <span style="font-weight:bold">ccc</span> was the cause &quote;</td>
	</tr>
</div>

</body>
</html>